#!/bin/bash

ONYX_USERNAME="[YOUR ONYX USERNAME HERE]"
ONYX_PASSWORD="[YOUR ONYX PASSWORD HERE]"

BASE_APP_URL="http://localhost:8080/onyx"
BASE_API_URL="http://localhost:8080/onyx/api/v1"

## Base-64 encoded version of JSON.sh (so we can parse JSON responses on the command line):
## https://raw.githubusercontent.com/dominictarr/JSON.sh/master/JSON.sh
JSON_SH_BASE64_ENCODED="IyEvYmluL3NoCgp0aHJvdygpIHsKICBlY2hvICIkKiIgPiYyCiAgZXhpdCAxCn0KCkJSSUVGPTAKTEVBRk9OTFk9MApQUlVORT0wCk5PX0hFQUQ9MApOT1JNQUxJWkVfU09MSURVUz0wCgp1c2FnZSgpIHsKICBlY2hvCiAgZWNobyAiVXNhZ2U6IEpTT04uc2ggWy1iXSBbLWxdIFstcF0gWy1zXSBbLWhdIgogIGVjaG8KICBlY2hvICItcCAtIFBydW5lIGVtcHR5LiBFeGNsdWRlIGZpZWxkcyB3aXRoIGVtcHR5IHZhbHVlcy4iCiAgZWNobyAiLWwgLSBMZWFmIG9ubHkuIE9ubHkgc2hvdyBsZWFmIG5vZGVzLCB3aGljaCBzdG9wcyBkYXRhIGR1cGxpY2F0aW9uLiIKICBlY2hvICItYiAtIEJyaWVmLiBDb21iaW5lcyAnTGVhZiBvbmx5JyBhbmQgJ1BydW5lIGVtcHR5JyBvcHRpb25zLiIKICBlY2hvICItbiAtIE5vLWhlYWQuIERvIG5vdCBzaG93IG5vZGVzIHRoYXQgaGF2ZSBubyBwYXRoIChsaW5lcyB0aGF0IHN0YXJ0IHdpdGggW10pLiIKICBlY2hvICItcyAtIFJlbW92ZSBlc2NhcGluZyBvZiB0aGUgc29saWR1cyBzeW1ib2wgKHN0cmFpZ2h0IHNsYXNoKS4iCiAgZWNobyAiLWggLSBUaGlzIGhlbHAgdGV4dC4iCiAgZWNobwp9CgpwYXJzZV9vcHRpb25zKCkgewogIHNldCAtLSAiJEAiCiAgbG9jYWwgQVJHTj0kIwogIHdoaWxlIFsgIiRBUkdOIiAtbmUgMCBdCiAgZG8KICAgIGNhc2UgJDEgaW4KICAgICAgLWgpIHVzYWdlCiAgICAgICAgICBleGl0IDAKICAgICAgOzsKICAgICAgLWIpIEJSSUVGPTEKICAgICAgICAgIExFQUZPTkxZPTEKICAgICAgICAgIFBSVU5FPTEKICAgICAgOzsKICAgICAgLWwpIExFQUZPTkxZPTEKICAgICAgOzsKICAgICAgLXApIFBSVU5FPTEKICAgICAgOzsKICAgICAgLW4pIE5PX0hFQUQ9MQogICAgICA7OwogICAgICAtcykgTk9STUFMSVpFX1NPTElEVVM9MQogICAgICA7OwogICAgICA/KikgZWNobyAiRVJST1I6IFVua25vd24gb3B0aW9uLiIKICAgICAgICAgIHVzYWdlCiAgICAgICAgICBleGl0IDAKICAgICAgOzsKICAgIGVzYWMKICAgIHNoaWZ0IDEKICAgIEFSR049JCgoQVJHTi0xKSkKICBkb25lCn0KCmF3a19lZ3JlcCAoKSB7CiAgbG9jYWwgcGF0dGVybl9zdHJpbmc9JDEKCiAgZ2F3ayAnewogICAgd2hpbGUgKCQwKSB7CiAgICAgIHN0YXJ0PW1hdGNoKCQwLCBwYXR0ZXJuKTsKICAgICAgdG9rZW49c3Vic3RyKCQwLCBzdGFydCwgUkxFTkdUSCk7CiAgICAgIHByaW50IHRva2VuOwogICAgICAkMD1zdWJzdHIoJDAsIHN0YXJ0K1JMRU5HVEgpOwogICAgfQogIH0nIHBhdHRlcm49IiRwYXR0ZXJuX3N0cmluZyIKfQoKdG9rZW5pemUgKCkgewogIGxvY2FsIEdSRVAKICBsb2NhbCBFU0NBUEUKICBsb2NhbCBDSEFSCgogIGlmIGVjaG8gInRlc3Qgc3RyaW5nIiB8IGVncmVwIC1hbyAtLWNvbG9yPW5ldmVyICJ0ZXN0IiA+L2Rldi9udWxsIDI+JjEKICB0aGVuCiAgICBHUkVQPSdlZ3JlcCAtYW8gLS1jb2xvcj1uZXZlcicKICBlbHNlCiAgICBHUkVQPSdlZ3JlcCAtYW8nCiAgZmkKCiAgaWYgZWNobyAidGVzdCBzdHJpbmciIHwgZWdyZXAgLW8gInRlc3QiID4vZGV2L251bGwgMj4mMQogIHRoZW4KICAgIEVTQ0FQRT0nKFxcW151WzpjbnRybDpdXXxcXHVbMC05YS1mQS1GXXs0fSknCiAgICBDSEFSPSdbXls6Y250cmw6XSJcXF0nCiAgZWxzZQogICAgR1JFUD1hd2tfZWdyZXAKICAgIEVTQ0FQRT0nKFxcXFxbXnVbOmNudHJsOl1dfFxcdVswLTlhLWZBLUZdezR9KScKICAgIENIQVI9J1teWzpjbnRybDpdIlxcXFxdJwogIGZpCgogIGxvY2FsIFNUUklORz0iXCIkQ0hBUiooJEVTQ0FQRSRDSEFSKikqXCIiCiAgbG9jYWwgTlVNQkVSPSctPygwfFsxLTldWzAtOV0qKShbLl1bMC05XSopPyhbZUVdWystXT9bMC05XSopPycKICBsb2NhbCBLRVlXT1JEPSdudWxsfGZhbHNlfHRydWUnCiAgbG9jYWwgU1BBQ0U9J1tbOnNwYWNlOl1dKycKCiAgIyBGb3JjZSB6c2ggdG8gZXhwYW5kICRBIGludG8gbXVsdGlwbGUgd29yZHMKICBsb2NhbCBpc193b3Jkc3BsaXRfZGlzYWJsZWQ9JCh1bnNldG9wdCAyPi9kZXYvbnVsbCB8IGdyZXAgLWMgJ15zaHdvcmRzcGxpdCQnKQogIGlmIFsgJGlzX3dvcmRzcGxpdF9kaXNhYmxlZCAhPSAwIF07IHRoZW4gc2V0b3B0IHNod29yZHNwbGl0OyBmaQogICRHUkVQICIkU1RSSU5HfCROVU1CRVJ8JEtFWVdPUkR8JFNQQUNFfC4iIHwgZWdyZXAgLXYgIl4kU1BBQ0UkIgogIGlmIFsgJGlzX3dvcmRzcGxpdF9kaXNhYmxlZCAhPSAwIF07IHRoZW4gdW5zZXRvcHQgc2h3b3Jkc3BsaXQ7IGZpCn0KCnBhcnNlX2FycmF5ICgpIHsKICBsb2NhbCBpbmRleD0wCiAgbG9jYWwgYXJ5PScnCiAgcmVhZCAtciB0b2tlbgogIGNhc2UgIiR0b2tlbiIgaW4KICAgICddJykgOzsKICAgICopCiAgICAgIHdoaWxlIDoKICAgICAgZG8KICAgICAgICBwYXJzZV92YWx1ZSAiJDEiICIkaW5kZXgiCiAgICAgICAgaW5kZXg9JCgoaW5kZXgrMSkpCiAgICAgICAgYXJ5PSIkYXJ5IiIkdmFsdWUiIAogICAgICAgIHJlYWQgLXIgdG9rZW4KICAgICAgICBjYXNlICIkdG9rZW4iIGluCiAgICAgICAgICAnXScpIGJyZWFrIDs7CiAgICAgICAgICAnLCcpIGFyeT0iJGFyeSwiIDs7CiAgICAgICAgICAqKSB0aHJvdyAiRVhQRUNURUQgLCBvciBdIEdPVCAke3Rva2VuOi1FT0Z9IiA7OwogICAgICAgIGVzYWMKICAgICAgICByZWFkIC1yIHRva2VuCiAgICAgIGRvbmUKICAgICAgOzsKICBlc2FjCiAgWyAiJEJSSUVGIiAtZXEgMCBdICYmIHZhbHVlPSQocHJpbnRmICdbJXNdJyAiJGFyeSIpIHx8IHZhbHVlPQogIDoKfQoKcGFyc2Vfb2JqZWN0ICgpIHsKICBsb2NhbCBrZXkKICBsb2NhbCBvYmo9JycKICByZWFkIC1yIHRva2VuCiAgY2FzZSAiJHRva2VuIiBpbgogICAgJ30nKSA7OwogICAgKikKICAgICAgd2hpbGUgOgogICAgICBkbwogICAgICAgIGNhc2UgIiR0b2tlbiIgaW4KICAgICAgICAgICciJyonIicpIGtleT0kdG9rZW4gOzsKICAgICAgICAgICopIHRocm93ICJFWFBFQ1RFRCBzdHJpbmcgR09UICR7dG9rZW46LUVPRn0iIDs7CiAgICAgICAgZXNhYwogICAgICAgIHJlYWQgLXIgdG9rZW4KICAgICAgICBjYXNlICIkdG9rZW4iIGluCiAgICAgICAgICAnOicpIDs7CiAgICAgICAgICAqKSB0aHJvdyAiRVhQRUNURUQgOiBHT1QgJHt0b2tlbjotRU9GfSIgOzsKICAgICAgICBlc2FjCiAgICAgICAgcmVhZCAtciB0b2tlbgogICAgICAgIHBhcnNlX3ZhbHVlICIkMSIgIiRrZXkiCiAgICAgICAgb2JqPSIkb2JqJGtleTokdmFsdWUiICAgICAgICAKICAgICAgICByZWFkIC1yIHRva2VuCiAgICAgICAgY2FzZSAiJHRva2VuIiBpbgogICAgICAgICAgJ30nKSBicmVhayA7OwogICAgICAgICAgJywnKSBvYmo9IiRvYmosIiA7OwogICAgICAgICAgKikgdGhyb3cgIkVYUEVDVEVEICwgb3IgfSBHT1QgJHt0b2tlbjotRU9GfSIgOzsKICAgICAgICBlc2FjCiAgICAgICAgcmVhZCAtciB0b2tlbgogICAgICBkb25lCiAgICA7OwogIGVzYWMKICBbICIkQlJJRUYiIC1lcSAwIF0gJiYgdmFsdWU9JChwcmludGYgJ3slc30nICIkb2JqIikgfHwgdmFsdWU9CiAgOgp9CgpwYXJzZV92YWx1ZSAoKSB7CiAgbG9jYWwganBhdGg9IiR7MTorJDEsfSQyIiBpc2xlYWY9MCBpc2VtcHR5PTAgcHJpbnQ9MAogIGNhc2UgIiR0b2tlbiIgaW4KICAgICd7JykgcGFyc2Vfb2JqZWN0ICIkanBhdGgiIDs7CiAgICAnWycpIHBhcnNlX2FycmF5ICAiJGpwYXRoIiA7OwogICAgIyBBdCB0aGlzIHBvaW50LCB0aGUgb25seSB2YWxpZCBzaW5nbGUtY2hhcmFjdGVyIHRva2VucyBhcmUgZGlnaXRzLgogICAgJyd8WyEwLTldKSB0aHJvdyAiRVhQRUNURUQgdmFsdWUgR09UICR7dG9rZW46LUVPRn0iIDs7CiAgICAqKSB2YWx1ZT0kdG9rZW4KICAgICAgICMgaWYgYXNrZWQsIHJlcGxhY2Ugc29saWR1cyAoIlwvIikgaW4ganNvbiBzdHJpbmdzIHdpdGggbm9ybWFsaXplZCB2YWx1ZTogIi8iCiAgICAgICBbICIkTk9STUFMSVpFX1NPTElEVVMiIC1lcSAxIF0gJiYgdmFsdWU9JChlY2hvICIkdmFsdWUiIHwgc2VkICdzI1xcLyMvI2cnKQogICAgICAgaXNsZWFmPTEKICAgICAgIFsgIiR2YWx1ZSIgPSAnIiInIF0gJiYgaXNlbXB0eT0xCiAgICAgICA7OwogIGVzYWMKICBbICIkdmFsdWUiID0gJycgXSAmJiByZXR1cm4KICBbICIkTk9fSEVBRCIgLWVxIDEgXSAmJiBbIC16ICIkanBhdGgiIF0gJiYgcmV0dXJuCgogIFsgIiRMRUFGT05MWSIgLWVxIDAgXSAmJiBbICIkUFJVTkUiIC1lcSAwIF0gJiYgcHJpbnQ9MQogIFsgIiRMRUFGT05MWSIgLWVxIDEgXSAmJiBbICIkaXNsZWFmIiAtZXEgMSBdICYmIFsgJFBSVU5FIC1lcSAwIF0gJiYgcHJpbnQ9MQogIFsgIiRMRUFGT05MWSIgLWVxIDAgXSAmJiBbICIkUFJVTkUiIC1lcSAxIF0gJiYgWyAiJGlzZW1wdHkiIC1lcSAwIF0gJiYgcHJpbnQ9MQogIFsgIiRMRUFGT05MWSIgLWVxIDEgXSAmJiBbICIkaXNsZWFmIiAtZXEgMSBdICYmIFwKICAgIFsgJFBSVU5FIC1lcSAxIF0gJiYgWyAkaXNlbXB0eSAtZXEgMCBdICYmIHByaW50PTEKICBbICIkcHJpbnQiIC1lcSAxIF0gJiYgcHJpbnRmICJbJXNdXHQlc1xuIiAiJGpwYXRoIiAiJHZhbHVlIgogIDoKfQoKcGFyc2UgKCkgewogIHJlYWQgLXIgdG9rZW4KICBwYXJzZV92YWx1ZQogIHJlYWQgLXIgdG9rZW4KICBjYXNlICIkdG9rZW4iIGluCiAgICAnJykgOzsKICAgICopIHRocm93ICJFWFBFQ1RFRCBFT0YgR09UICR0b2tlbiIgOzsKICBlc2FjCn0KCmlmIChbICIkMCIgPSAiJEJBU0hfU09VUkNFIiBdIHx8ICEgWyAtbiAiJEJBU0hfU09VUkNFIiBdKTsKdGhlbgogIHBhcnNlX29wdGlvbnMgIiRAIgogIHRva2VuaXplIHwgcGFyc2UKZmkKCiMgdmk6IGV4cGFuZHRhYiBzdz0yIHRzPTIK"

JSON_SH="/tmp/json.sh"
echo -en "${JSON_SH_BASE64_ENCODED}" | base64 --decode > ${JSON_SH}
chmod +x ${JSON_SH}

COOKIE_JAR=$(curl -s --cookie-jar - -H"Content-Type: application/x-www-form-urlencoded" \
  -d "username=$ONYX_USERNAME" \
  -d "password=$ONYX_PASSWORD" $BASE_APP_URL/login -o /dev/null | awk '{print $NF}')
if [ -z "$COOKIE_JAR" ]; then
  echo "Login failed - invalid username/password."
  exit 1;
fi

SESSION_COOKIE=`echo $COOKIE_JAR | awk '{print $NF}'`

find $@ -type f -print0 | while IFS= read -r -d '' i; do
  FILE="$(perl -MURI::Escape -e 'print uri_escape($ARGV[0],"^A-Za-z0-9\-\._~\/");' "$i")"
  FILESIZE=$(wc -c < "$i")

  API_JSON_RESPONSE=$(curl -s -X POST -H"Content-Type: application/json" \
    -b "_onyx=$SESSION_COOKIE" \
    --data '{"size":"'"$FILESIZE"'","description":"","visibility":"PRIVATE"}' \
    "$BASE_API_URL/file/$ONYX_USERNAME/$FILE?recursive=true")
  if [ ! -z "$API_JSON_RESPONSE" ]; then
    PRESIGNED_UPLOAD_URL=$(echo $API_JSON_RESPONSE | ${JSON_SH} | \
      egrep '\["presignedUploadUrl"]' | awk '{print $2}' | tr -d '"')

    echo "$i"
    curl -# -X PUT -T "$i" \
        --limit-rate 300k \
        --connect-timeout 120 \
        $PRESIGNED_UPLOAD_URL > /dev/null
  else
    echo "File exists, skipping: $i"
  fi
done
